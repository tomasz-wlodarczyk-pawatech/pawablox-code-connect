name: Generate Icons from Figma

on:
  workflow_dispatch:
    inputs:
      icons_node_id:
        description: 'Figma node ID containing icons (e.g., 1565-5788 from URL or 1565:5788)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  FIGMA_ICONS_FILE_KEY: Rmvx5Nqkr7KrFx9lev2OeT

jobs:
  generate-icons:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate icons from Figma
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_ICONS_NODE_ID: ${{ inputs.icons_node_id }}
        run: |
          echo "Starting icon generation..."
          echo "File key: $FIGMA_ICONS_FILE_KEY"
          echo "Node ID: $FIGMA_ICONS_NODE_ID"
          bun script:icons

      - name: List generated files
        run: |
          echo "### Generated files:"
          if [ -d "packages/icons/src/icons" ]; then
            ls -la packages/icons/src/icons/ || echo "No icons directory"
          else
            echo "Icons directory does not exist"
          fi
          echo ""
          echo "### Index file:"
          cat packages/icons/src/index.ts || echo "Index file not found"

      - name: Check for changes
        id: git-check
        run: |
          echo "Checking for changes..."
          git status
          git add packages/icons/src/
          if git diff --cached --quiet packages/icons/src/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "### Changed files:" >> $GITHUB_STEP_SUMMARY
            git diff --cached --stat packages/icons/src/ >> $GITHUB_STEP_SUMMARY
            echo "Changes detected:"
            git diff --cached --stat packages/icons/src/
          fi

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(icons): regenerate icons from Figma"
          title: "Update Icons from Figma"
          body: |
            ## Icons Update

            This PR was automatically generated from Figma icons.

            ### Source
            - **Figma File**: `${{ env.FIGMA_ICONS_FILE_KEY }}`
            - **Node ID**: `${{ inputs.icons_node_id }}`

            ### Changes
            - Regenerated icon components from Figma design system
            - Updated barrel exports in `packages/icons/src/index.ts`

            ### Files updated
            - `packages/icons/src/icons/*.tsx` - Icon components
            - `packages/icons/src/index.ts` - Barrel exports

            ---
            Auto-generated by GitHub Actions
          branch: feat/update-icons-from-figma
          delete-branch: true
          add-paths: |
            packages/icons/src/*
